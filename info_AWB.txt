
ssh -X -Y abrinke1@gpu006
cd /cms/data/abrinke1/CMSSW/HiggsToAA/ParticleNet/

https://github.com/hqucms/weaver#readme
git clone git@github.com:hqucms/weaver.git

# create a new conda environment
conda create -n weaver python=3.7

# activate the environment
conda activate weaver

# install the necessary python packages
pip install numpy pandas scikit-learn scipy matplotlib tqdm PyYAML

# install uproot for reading/writing ROOT files
pip install uproot3 awkward0 lz4 xxhash

# install PyTables if using HDF5 files
pip install tables

# install onnxruntime if needs to run inference w/ ONNX models
pip install onnxruntime-gpu

# install tensorboard for visualization
pip install tensorboard

# install pytorch, follow instructions for your OS/CUDA version at:
# https://pytorch.org/get-started
pip install torch
conda install pytorch torchvision torchaudio pytorch-cuda=11.7 -c pytorch -c nvidia

-----------------------------------------------------------------------------------

conda activate weaver
mkdir output

python train.py --data-train '/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/*root' --data-config data/Hto4b_ak8_points_pf_sv_full.yaml --network-config networks/particle_net_pf_sv.py --num-epochs 10 --model-prefix output/M-all-E10

python train.py --predict --data-test '/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/*root' --data-config data/Hto4b_ak8_points_pf_sv_full.yaml --network-config networks/particle_net_pf_sv.py --model-prefix output/M-all-E10 --predict-output output/predict_M-all-E10.root

python train.py --regression-mode --data-train '/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_HToAA*.root' --data-config data/Hto4b_ak8_points_pf_sv_mass_regression.yaml --network-config networks/particle_net_pf_sv_mass_regression.py --num-epochs 40 --model-prefix output/M-regr-E40

python train.py --predict --regression-mode --data-test '/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/*.root' --data-config data/Hto4b_ak8_points_pf_sv_mass_regression.yaml --network-config networks/particle_net_pf_sv_mass_regression.py --model-prefix output/M-regr-E40 --predict-output output/predict_M-regr-E40.root

-----------------------------------------------------------------------------------

python train.py -i Sig_wH-70:/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt*50_mH-70_mA-12_wH-70_wA-*0_TuneCP5_13TeV_madgraph_pythia8.root QCD:/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_QCD_*_HT*to*.root -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass.yaml -n networks/particle_net_pf_sv.py --num-epochs 30 -m output/multiclass_wH-70_E30_AWB_2023_05_30

python train.py --predict -t Sig_mH-125:/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_HToAATo4B_GluGluH_01J_Pt150_M-*.root QCD:/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_QCD_*_HT*to*.root -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass.yaml -n networks/particle_net_pf_sv.py -m output/multiclass_wH-70_E30_AWB_2023_05_30 --predict-output output/predict_multiclass_wH-70_E30_AWB_2023_05_30.root

python train.py --predict -t Sig_wH-70:/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt*50_mH-70_mA-12_wH-70_wA-*0_TuneCP5_13TeV_madgraph_pythia8.root -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass.yaml -n networks/particle_net_pf_sv.py -m output/multiclass_wH-70_E30_AWB_2023_05_30 --predict-output output/predict_multiclass_wH-70_E30_AWB_2023_05_30.root

## https://github.com/hqucms/weaver#model-exportation
mkdir -p models/2023_05_30/
python train.py -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass.yaml -n networks/particle_net_pf_sv.py -m output/multiclass_wH-70_E30_AWB_2023_05_30_best_epoch_state.pt --export-onnx models/2023_05_30/multiclass_wH-70_E30_AWB_2023_05_30_v12.onnx

-----------------------------------------------------------------------------------

https://github.com/cms-data/RecoBTag-Combined/tree/master/ParticleNetAK8/MassRegression/V01

### Testing ONNX in regression mode (success!) ###

python train.py --regression-mode -i '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py --num-epochs 5 -m output/M-regr-E05_test
python train.py -c data/Hto4b_ak8_points_pf_sv_mass_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py -m output/M-regr-E05_test_best_epoch_state.pt --export-onnx models/2023_08_30/M-regr-E05_test_AWB_2023_08_30.onnx

python train.py --predict --regression-mode -t '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py -m output/M-regr-E05_test --predict-output output/predict_M-regr-E05_test.root
python train.py --predict --regression-mode -t '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py -m models/2023_08_30/M-regr-E05_test_AWB_2023_08_30.onnx --predict-output output/predict_M-regr-E05_test_onnx.root

## Testing ONNX in regression mode with Si's files ###

python train.py -c data/Hto4b_ak8_points_pf_sv_mass_regression_Si.yaml -n networks/particle_net_pf_sv_mass_regression.py -m wide_H_calc_mass_regr_best_epoch_state.pt --export-onnx models/2023_08_30/wide_H_calc_mass_regr_Si_2023_08_30.onnx

python train.py --predict --regression-mode -t '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression_Si.yaml -n networks/particle_net_pf_sv_mass_regression.py -m /home/chosila/Projects/weaver/output/wide_H_calc_mass_regr --predict-output output/predict_wide_H_calc_mass_regr_Si_test.root
python train.py --predict --regression-mode -t '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression_Si.yaml -n networks/particle_net_pf_sv_mass_regression.py -m models/2023_08_30/wide_H_calc_mass_regr_Si_2023_08_30.onnx --predict-output output/predict_wide_H_calc_mass_regr_Si_test_onnx.root

** In train.py, change opset_version from 13 to 12
python train.py -c data/Hto4b_ak8_points_pf_sv_mass_regression_Si.yaml -n networks/particle_net_pf_sv_mass_regression.py -m output/wide_H_calc_mass_regr_best_epoch_state.pt --export-onnx models/2023_08_30/wide_H_calc_mass_regr_Si_2023_08_30_v12.onnx
python train.py --predict --regression-mode -t '/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt350_mH-70_mA-12_wH-70_wA-10_TuneCP5_13TeV_madgraph_pythia8.root' -c data/Hto4b_ak8_points_pf_sv_mass_regression_Si.yaml -n networks/particle_net_pf_sv_mass_regression.py -m models/2023_08_30/wide_H_calc_mass_regr_Si_2023_08_30_v12.onnx --predict-output output/predict_wide_H_calc_mass_regr_Si_test_onnx_v12.root

-----------------------------------------------------------------------------------

## Classification
python train.py -i Sig_wH-70:/cms/data/chosila/Ntuples/AK8_SUSY_GluGluH_01J_HToAATo4B_Pt*50_mH-70_mA-12_wH-70_wA-*0_TuneCP5_13TeV_madgraph_pythia8.root QCD:/cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_QCD_*_HT*to*.root -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass_No_.yaml -n networks/particle_net_pf_sv.py --num-epochs 30 -m output/multiclass_wH-70_E30_AWB_2023_08_31

python train.py -c data/Hto4b_ak8_points_pf_sv_full_wH-70_multiclass_No_.yaml -n networks/particle_net_pf_sv.py -m output/multiclass_wH-70_E30_AWB_2023_08_31_best_epoch_state.pt --export-onnx models/2023_08_31/multiclass_wH-70_E30_AWB_2023_08_31_v12.onnx

## "a" boson mass regression
python train.py --regression-mode -i /cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_HToAATo4B_GluGluH_01J_Pt150_M-*.root -c data/Hto4b_ak8_points_pf_sv_massA_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py --num-epochs 40 -m output/MA-regr_mH-125_E40_AWB_2023_08_31

python train.py -c data/Hto4b_ak8_points_pf_sv_massA_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py -m output/MA-regr_mH-125_E40_AWB_2023_08_31_best_epoch_state.pt --export-onnx models/2023_08_31/MA-regr_mH-125_E40_AWB_2023_08_31_v12.onnx

##  log("a" boson mass) regression
python train.py --regression-mode -i /cms/data/store/user/abrinke1/Trees/HtoAAto4B/ParticleNet/Ntuples/2022_11_14/AK8_HToAATo4B_GluGluH_01J_Pt150_M-*.root -c data/Hto4b_ak8_points_pf_sv_logMassA_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py --network-option loss_mode 0 --num-epochs 40 -m output/MA-regr_log_mode0_mH-125_E40_AWB_2023_08_31

python train.py -c data/Hto4b_ak8_points_pf_sv_logMassA_regression.yaml -n networks/particle_net_pf_sv_mass_regression.py -m output/MA-regr_log_mode0_mH-125_E40_AWB_2023_08_31_best_epoch_state.pt --export-onnx models/2023_08_31/MA-regr_log_mode0_mH-125_E40_AWB_2023_08_31_v12.onnx



-----------------------------------------------------------------------------------

git remote add abrinke1 git@github.com:abrinke1/weaver.git
git checkout -b AWB_Hto4b_dev
git add files_to_add
git commit -m "Commit message"
git push abrinke1 
